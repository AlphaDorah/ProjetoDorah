<!DOCTYPE html>

<html lang="pt-br" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8">
    <title>Teste da biblioteca GoJS</title>
    <script src="https://unpkg.com/gojs/release/go-debug.js"></script>

    <script>

        var tema_central = "Segunda Guerra Mundial";
        var subtemas = ["Bombas nucleares", "Pa√≠ses que participaram", "Tratado de versales", "Batalhas", "Alemanha"]
        var resumos = ["1. Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
            "2. Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
            "3. Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
            "4. Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
            "5. Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
            "6. Lorem ipsum dolor sit amet, consectetur adipiscing elit."]

        var total_temas = subtemas.length + 1;

        function init() {
            const $ = go.GraphObject.make;

            diagram =
                new go.Diagram("mapa_mental",
                    {
                        allowCopy: false,
                        allowDelete: true,
                        maxSelectionCount: 1,
                        "undoManager.isEnabled": true,
                        "commandHandler.deletesTree": true,
                        "draggingTool.dragsTree": true,

                        layout:
                            $(go.TreeLayout,
                                { angle: 90, nodeSpacing: 10, layerSpacing: 40, layerStyle: go.TreeLayout.LayerUniform })
                    });

            //Design START

            diagram.nodeTemplate =
                $(go.Node, "Auto",
                    $(go.Shape, "RoundedRectangle", {
                        stroke: "#757575",
                        strokeWidth: 3,
                        fill: "white"
                    }),
                    $(go.TextBlock, { margin: 10, font: "18px sans-serif" },
                        new go.Binding("text"))
                );

            diagram.nodeTemplate.selectionAdornmentTemplate =
                $(go.Adornment, "Spot",
                    $(go.Panel, "Auto",
                        $(go.Shape, "RoundedRectangle", { fill: null, stroke: "black", strokeWidth: 3 }),
                        $(go.Placeholder, { margin: 5 })
                    ),
                    $(go.Panel, "Auto", {
                        alignment: go.Spot.Bottom,
                        alignmentFocus: go.Spot.Top
                    },
                        $(go.Shape, "RoundedRectangle",
                            {
                                fill: "white", stroke: "black", strokeWidth: 3
                            }),
                        $(go.TextBlock, { font: "bold 15px sans-serif", stroke: "#757575", margin: 10 },
                            new go.Binding("text", "sumary")),
                    ),
                    $("Button",
                        {
                            alignment: go.Spot.Right,
                            "ButtonBorder.figure": "Circle",
                            "ButtonBorder.fill": "white",
                            "ButtonBorder.stroke": "black",
                            "ButtonBorder.strokeWidth": 3,

                            click: addNodeAndLink
                        },
                        $(go.TextBlock, "+",
                            { font: "bold 15px sans-serif", stroke: "#757575" }),
                    )
                );

            diagram.linkTemplate =
                $(go.Link,
                    { routing: go.Link.Orthogonal, corner: 5, selectable: false },
                    $(go.Shape,
                        { strokeWidth: 3, stroke: "#757575" })
                );

            //Design END

            function addNodeAndLink(e, obj) {
                var adorn = obj.part;

                diagram.startTransaction("Add Node");
                var oldnode = adorn.adornedPart;

                var newdata = { key: total_temas + 1, text: `Novo Subtema ${total_temas}`, sumary: `Resumo do subtema ${total_temas}` };
                diagram.model.addNodeData(newdata);
                diagram.model.addLinkData({ from: oldnode.key, to: newdata.key })

                total_temas++;

                diagram.commitTransaction("Add Node");

                var newnode = diagram.findNodeForData(newdata);
                if (newnode !== null) diagram.scrollToRect(newnode.actualBounds);
            }

            var nodeDataArray = [{ key: 1, text: tema_central, sumary: resumos[0] }];
            for (let i = 0; i < subtemas.length; i++) {
                nodeDataArray.push({ key: i + 2, text: subtemas[i], sumary: resumos[i + 1] });
            }

            var linkDataArray = [];
            for (let i = 0; i < subtemas.length; i++) {
                linkDataArray.push({ to: i + 2, from: 1 });
            }

            diagram.model = new go.GraphLinksModel(nodeDataArray, linkDataArray);

        }

    </script>
</head>

<body onload="init()">
    <div id="mapa_mental" style="width: 800px; height: 600px;"></div>
</body>

</html>